import{a as Te,c as G}from"./chunk-ADONZQUO.js";import{a as Ce,b as K,c as Se,d as we,e as ke,f as _e,g as De,i as Me,k as Q}from"./chunk-7KIS5EUS.js";import{a as Y}from"./chunk-BBJGFF6W.js";import{b as Ie}from"./chunk-Z6ONODYV.js";import{a as xe}from"./chunk-FXKGETAD.js";import{k as ye,m as w}from"./chunk-EJSN6NP7.js";import{A as oe,Ab as $,Db as q,Eb as P,Fb as B,G as se,Gb as C,H as ie,Ib as z,Kb as ge,Lb as he,Mb as be,Nb as ve,O as W,P as ae,Q as ce,Qa as d,Ra as ue,U,Xa as S,Zb as X,_ as g,a as H,b as J,f as ee,fa as le,ha as T,i as F,ia as A,jb as y,k as te,l as I,mb as de,oa as V,ob as v,q as k,qa as E,qb as pe,rb as me,sb as fe,tb as j,ub as O,v as re,vb as c,wb as l,xb as _,yb as L,z as ne,zb as x}from"./chunk-QEFPM76F.js";function R(r){r||(le(R),r=g(V));let u=new ee(e=>r.onDestroy(e.next.bind(e)));return e=>e.pipe(ae(u))}var D=class{constructor(u,e){this.content=u,this.role=e}};function Ae(r){try{return JSON.parse(r)}catch{return null}}var M=(()=>{class r{constructor(){this.http=g(xe),this.urlService=g(Y)}getUrlSegment(){return this.urlService.URLS.CONVERSATION}getConversations(e=0,t=100){let n=`${this.getUrlSegment()}?skip=${e}&limit=${t}`;return this.http.get(n).pipe(k(s=>J(H({},s),{conversations:s.conversations.filter(a=>a.title).sort((a,m)=>new Date(m.updatedAt).getTime()-new Date(a.updatedAt).getTime())})))}getConversationMessages(e){let t=`${this.getUrlSegment()}/${e}`;return this.http.get(t)}static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275prov=U({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();var Ee=(()=>{class r{constructor(){this.conversationService=g(M),this.urlService=g(Y),this.messages=y([]),this.status=y(!1),this.conversationId=y(""),this.messagesSubject=new F,this.streamingAssistantSubject=new F}getUrlSegment(){return this.urlService.URLS.AI_CHAT_ASSISTANT}getAccessToken(){return localStorage.getItem("access_token")}getMessages(){return this.messagesSubject.asObservable()}setMessages(e){this.messages.set(e)}getStreamingAssistant(){return this.streamingAssistantSubject.asObservable()}sendMessage(e,t){let n=`${this.getUrlSegment()}?nocache=true&auto_set_title=true`,s=this.getAccessToken(),a={"Content-Type":"application/json"};s&&(a.Authorization=`Bearer ${s}`);let m=JSON.stringify({prompt:e,conversationId:t||this.conversationId()});this.messages.update(b=>[...b,new D(e,"user")]),this.messagesSubject.next(this.messages()),this.status.set(!0);let h="";return re(()=>I(fetch(n,{method:"POST",headers:a,body:m}))).pipe(W(b=>{if(!b.ok||!b.body)throw new Error("Fetch failed or response has no body");let f=b.body.getReader(),p=new TextDecoder;return I(f.read()).pipe(se(()=>I(f.read())),ce(({done:o})=>!o,!0),k(({value:o})=>p.decode(o||new Uint8Array,{stream:!0})),k(o=>o.split(`
`).filter(i=>i.startsWith("data: ")).map(i=>i.slice(6))),W(o=>I(o)),k(o=>{if(o==="[DONE]")return{type:"done"};let i=Ae(o);return i.event==="metadata"?{type:"metadata",data:i}:i.role==="assistant"?{type:"content",data:i}:{type:"unknown",data:i}}),ne(o=>o!==null),k(o=>(o.data?.conversationId&&this.conversationId.set(o.data.conversationId),o.type==="content"&&(h+=o.data.content||"",this.streamingAssistantSubject.next(h)),o)),ie(()=>{h&&(this.messages.update(o=>[...o,new D(h,"assistant")]),this.messagesSubject.next(this.messages())),this.status.set(!1)}),oe(o=>(console.error("SSE error:",o),this.status.set(!1),te)))}))}resetChat(){this.messages.set([]),this.status.set(!1),this.conversationId.set(""),this.messagesSubject.next(this.messages()),this.conversationService.getConversations()}startActionStream(){let e=this.getAccessToken(),t=`${this.getUrlSegment()}actions`;fetch(t,{method:"GET",headers:{Authorization:"Bearer "+e,Connection:"keep-alive","X-Client":"web"}}).then(n=>{if(!n.body)throw new Error("ReadableStream not supported by the browser");let s=n.body.getReader(),a=new TextDecoder("utf-8"),m="",h=()=>{s.read().then(({done:b,value:f})=>{if(b){console.log("Stream closed by server");return}m+=a.decode(f,{stream:!0});let p=m.split(`
`);m=p.pop()||"";for(let o of p)if(o.startsWith("data:")){let i=o.replace("data:","").trim();this.messages.update(Re=>[...Re,new D(i,"tool")]),this.messagesSubject.next(this.messages())}h()})};h()}).catch(n=>{console.error("Streaming fetch error:",n)})}static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275prov=U({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();var Fe=(r,u,e,t,n)=>({"bg-chat-user-bg dark:bg-blue-900 text-chat-user-text dark:text-blue-100 ml-auto":r,"bg-chat-assistant-bg dark:bg-purple-900 text-chat-assistant-text dark:text-purple-100 mr-auto":u,"text-xs bg-chat-tool-bg dark:bg-accent-yellow/10 text-chat-tool-text dark:text-accent-yellow mx-auto text-center p-1":e,"bg-chat-system-bg dark:bg-yellow-900 text-chat-system-text dark:text-yellow-100 mx-auto text-center":t,"bg-chat-developer-bg dark:bg-pink-900 text-chat-developer-text dark:text-pink-100 mx-auto text-center":n}),je=(()=>{class r{static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275cmp=S({type:r,selectors:[["app-chat-message"]],inputs:{message:"message"},decls:3,vars:8,consts:[[1,"flex","w-full","mb-3"],[1,"p-3","rounded-lg","max-w-[80%]","whitespace-pre-wrap",3,"ngClass"],[3,"data"]],template:function(t,n){t&1&&(c(0,"div",0)(1,"div",1),_(2,"markdown",2),l()()),t&2&&(d(),v("ngClass",he(2,Fe,n.message.role==="user",n.message.role==="assistant",n.message.role==="tool",n.message.role==="system",n.message.role==="developer")),d(),v("data",n.message.content))},dependencies:[w,ye,G,Te],encapsulation:2})}}return r})();var Ue=["promptInput"],Z=(()=>{class r{constructor(){this.isStreaming=!1,this.send=new E}focus(){setTimeout(()=>{this.promptInput?.nativeElement.focus()})}onSubmit(){this.send.emit()}onEnter(e){this.isStreaming||this.send.emit(e)}static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275cmp=S({type:r,selectors:[["app-chat-input"]],viewQuery:function(t,n){if(t&1&&q(Ue,5),t&2){let s;P(s=B())&&(n.promptInput=s.first)}},inputs:{form:"form",isStreaming:"isStreaming"},outputs:{send:"send"},decls:5,vars:3,consts:[["promptInput",""],[1,"flex","gap-2","mt-4",3,"ngSubmit","formGroup"],["type","text","formControlName","prompt","placeholder","Type your message...",1,"flex-1","px-4","py-2","border","border-gray-300","dark:border-gray-600","rounded-lg","focus:outline-none","focus:ring-2","focus:ring-blue-500","disabled:bg-gray-100","dark:disabled:bg-gray-700","bg-white","dark:bg-dark-surface","text-gray-900","dark:text-white","placeholder-gray-500","dark:placeholder-gray-400",3,"keydown.enter","disabled"],["type","submit",1,"px-6","py-2","bg-blue-600","dark:bg-blue-500","text-white","rounded-lg","hover:bg-blue-700","dark:hover:bg-blue-600","focus:outline-none","focus:ring-2","focus:ring-blue-500","dark:focus:ring-blue-400","disabled:bg-gray-300","dark:disabled:bg-gray-600","disabled:text-gray-500","dark:disabled:text-gray-400","disabled:cursor-not-allowed","transition-colors","duration-200",3,"disabled"]],template:function(t,n){if(t&1){let s=L();c(0,"form",1),x("ngSubmit",function(){return T(s),A(n.onSubmit())}),c(1,"input",2,0),x("keydown.enter",function(m){return T(s),A(n.onEnter(m))}),l(),c(3,"button",3),C(4," Send "),l()()}t&2&&(v("formGroup",n.form),d(),v("disabled",n.isStreaming),d(2),v("disabled",n.form.invalid||n.isStreaming))},dependencies:[w,Q,ke,Ce,Se,we,_e,De],encapsulation:2})}}return r})();var Ve=(r,u)=>u.title,Le=(r,u)=>u.id;function $e(r,u){if(r&1){let e=L();c(0,"div",9),x("click",function(){let n=T(e).$implicit,s=$(2);return A(s.onConversationClick(n))}),C(1),l()}if(r&2){let e=u.$implicit;d(),z(" ",e.title," ")}}function qe(r,u){if(r&1&&(c(0,"div",6)(1,"h3",7),C(2),l(),j(3,$e,2,1,"div",8,Le),l()),r&2){let e=u.$implicit;d(2),z(" ",e.title," "),d(),O(e.conversations)}}var Oe=(()=>{class r{constructor(e){this.conversationService=e,this.conversationSelected=new E,this.createNewChat=new E,this.conversations=y([]),this.loadConversations()}loadConversations(){this.conversationService.getConversations().subscribe({next:e=>{let t=this.groupConversations(e.conversations);this.conversations.set(t)},error:e=>{console.error("Error loading conversations:",e)}})}groupConversations(e){let t=new Date,n=new Date(t.getFullYear(),t.getMonth(),t.getDate()),s=new Date(n);s.setDate(s.getDate()-1);let a=new Date(n);a.setDate(a.getDate()-3);let m=new Date(n);m.setDate(m.getDate()-7);let h=new Date(n);h.setMonth(h.getMonth()-1);let b=new Date(n);b.setFullYear(b.getFullYear()-1);let f=[{title:"Today",conversations:[]},{title:"Yesterday",conversations:[]},{title:"Last 3 Days",conversations:[]},{title:"Last Week",conversations:[]},{title:"Last Month",conversations:[]},{title:"Last Year",conversations:[]},{title:"Older",conversations:[]}];return e.forEach(p=>{let o=new Date(p.updatedAt),i=new Date(o.getFullYear(),o.getMonth(),o.getDate());i.getTime()===n.getTime()?f[0].conversations.push(p):i.getTime()===s.getTime()?f[1].conversations.push(p):i>=a&&i<s?f[2].conversations.push(p):i>=m&&i<a?f[3].conversations.push(p):i>=h&&i<m?f[4].conversations.push(p):i>=b&&i<h?f[5].conversations.push(p):f[6].conversations.push(p)}),f.filter(p=>p.conversations.length>0)}onConversationClick(e){console.log("Conversation clicked:",e.id),this.conversationSelected.emit(e.id)}onNewChatClick(){console.log("New chat clicked"),this.createNewChat.emit()}static{this.\u0275fac=function(t){return new(t||r)(ue(M))}}static{this.\u0275cmp=S({type:r,selectors:[["app-conversation-sidebar"]],outputs:{conversationSelected:"conversationSelected",createNewChat:"createNewChat"},decls:11,vars:4,consts:[[1,"h-full","flex","flex-col","bg-white","dark:bg-dark-surface"],[1,"text-xl","font-bold","p-4","text-center","border-b","border-gray-200","dark:border-gray-700","text-gray-900","dark:text-white"],[1,"p-4","border-b","border-gray-200","dark:border-gray-700"],[1,"w-full","py-2","px-4","bg-blue-600","hover:bg-blue-700","text-white","rounded-lg","transition-colors","duration-200","flex","items-center","justify-center","gap-2",3,"click"],[1,"text-xl"],[1,"flex-1","overflow-y-auto","p-4","space-y-4","scrollbar-custom"],[1,"space-y-2"],[1,"text-sm","font-semibold","text-gray-500","dark:text-gray-400","mb-2"],[1,"px-3","py-1","hover:bg-gray-100","dark:hover:bg-gray-700","cursor-pointer","rounded-lg","border","border-gray-200","dark:border-gray-700","transition-colors","duration-200","text-gray-700","dark:text-gray-300","hover:text-gray-900","dark:hover:text-white","text-s"],[1,"px-3","py-1","hover:bg-gray-100","dark:hover:bg-gray-700","cursor-pointer","rounded-lg","border","border-gray-200","dark:border-gray-700","transition-colors","duration-200","text-gray-700","dark:text-gray-300","hover:text-gray-900","dark:hover:text-white","text-s",3,"click"]],template:function(t,n){t&1&&(c(0,"div",0)(1,"h2",1),C(2," Conversations "),l(),c(3,"div",2)(4,"button",3),x("click",function(){return n.onNewChatClick()}),_(5,"i",4),be(6,"icon"),C(7," New Chat "),l()(),c(8,"div",5),j(9,qe,5,1,"div",6,Ve),l()()),t&2&&(d(5),pe(ve(6,2,"PLUS")),d(4),O(n.conversations()))},dependencies:[w,Ie],encapsulation:2})}}return r})();var Pe=r=>({role:"assistant",content:r});function Be(r,u){if(r&1&&_(0,"app-chat-message",5),r&2){let e=u.$implicit;v("message",e)}}function Qe(r,u){if(r&1&&_(0,"app-chat-message",5),r&2){let e=$();v("message",ge(1,Pe,e.streamingAssistantContent()))}}var tr=(()=>{class r{constructor(){this.destroyRef=g(V),this.fb=g(Me),this.chatService=g(Ee),this.conversationService=g(M),this.messages=this.chatService.messages,this.streamingAssistantContent=y(""),this.isStreaming=this.chatService.status,this.form=this.fb.group({prompt:[{value:"",disabled:!1},[K.required,K.minLength(1)]]}),X(()=>{let e=this.chatService.status(),t=this.form.get("prompt");t&&(e?t.disable():(t.enable(),this.chatInput?.focus()))})}ngOnInit(){this.subscribeToMessages(),this.subscribeToStreaming(),this.chatService.startActionStream()}ngAfterViewInit(){this.chatInput?.focus()}subscribeToMessages(){this.chatService.getMessages().pipe(R(this.destroyRef)).subscribe()}subscribeToStreaming(){this.chatService.getStreamingAssistant().pipe(R(this.destroyRef)).subscribe(e=>{this.streamingAssistantContent.set(e)})}async handleSendMessage(e){if(e&&e.preventDefault(),this.form.invalid||this.chatService.status())return;let t=this.form.value.prompt;this.form.reset(),this.streamingAssistantContent.set("");try{this.chatService.sendMessage(t).subscribe({error:n=>{console.error("Error sending message:",n)}})}catch(n){console.error("Error sending message:",n)}}onCreateNewChatClicked(){this.chatService.resetChat()}onConversationSelected(e){this.chatService.conversationId.set(e),this.conversationService.getConversationMessages(e).pipe(R(this.destroyRef)).subscribe({next:t=>{this.chatService.setMessages(t.messages),this.chatInput.focus()},error:t=>{console.error("Error fetching conversation messages:",t)}})}static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275cmp=S({type:r,selectors:[["app-ai-chat-assistant"]],viewQuery:function(t,n){if(t&1&&q(Z,5),t&2){let s;P(s=B())&&(n.chatInput=s.first)}},decls:11,vars:3,consts:[[1,"flex","h-[calc(100vh-11rem)]","rounded-xl","border","border-gray-200","dark:border-gray-700"],[1,"w-80","border-r","border-gray-200","dark:border-gray-700",3,"conversationSelected","createNewChat"],[1,"flex-1","flex","flex-col","h-full","bg-white","dark:bg-dark-surface"],[1,"text-xl","font-bold","p-4","text-center","border-b","border-gray-200","dark:border-gray-700","text-gray-900","dark:text-white"],[1,"flex-1","overflow-y-auto","p-4"],[3,"message"],[1,"p-4","border-t","border-gray-200","dark:border-gray-700"],[3,"send","form","isStreaming"]],template:function(t,n){t&1&&(c(0,"div",0)(1,"app-conversation-sidebar",1),x("conversationSelected",function(a){return n.onConversationSelected(a)})("createNewChat",function(){return n.onCreateNewChatClicked()}),l(),c(2,"div",2)(3,"h1",3),C(4," AI Chat Assistant "),l(),c(5,"div",4),j(6,Be,1,1,"app-chat-message",5,fe),de(8,Qe,1,3,"app-chat-message",5),l(),c(9,"div",6)(10,"app-chat-input",7),x("send",function(a){return n.handleSendMessage(a)}),l()()()()),t&2&&(d(6),O(n.messages()),d(2),me(n.streamingAssistantContent()&&n.chatService.status()?8:-1),d(2),v("form",n.form)("isStreaming",n.chatService.status()))},dependencies:[w,Q,je,Z,Oe,G],encapsulation:2})}}return r})();export{tr as AIChatAssistantComponent};
