import{a as ie,b as Q,c as oe,d as ae,e as ce,f as ue,g as me,i as le,k as F}from"./chunk-QSXUJ6SF.mjs";import{a as pe}from"./chunk-SIBW56CM.mjs";import{$ as q,Aa as ee,Ba as D,Ca as R,Da as E,Ea as b,Ga as te,Ia as se,J as o,Ja as ne,M as H,Q as l,Qa as U,S as J,Sa as d,U as M,V as j,Va as re,Wa as C,Ya as O,_ as T,ca as c,f as i,fa as y,g as k,h as A,ka as g,l as B,ma as z,n as L,o as Ce,oa as u,p as P,ra as W,sa as K,t as Se,ta as X,ua as Y,va as a,wa as m,xa as N,ya as Z,za as v}from"./chunk-7255E2OS.mjs";i();o();d();i();o();d();L();Ce();function V(e){e||(J(V),e=l(T));let p=new k(s=>e.onDestroy(s.next.bind(s)));return s=>s.pipe(B(p))}O();i();o();d();Se();L();i();o();var x=class{constructor(p,s){this.content=p,this.role=s}};d();var de=(()=>{class e{constructor(){this.http=l(P),this.urlService=l(pe),this.messages=g([]),this.status=g(!1),this.conversationId=g(""),this.messagesSubject=new A,this.streamingAssistantSubject=new A}getUrlSegment(){return this.urlService.URLS.AI_CHAT_ASSISTANT}getAccessToken(){return localStorage.getItem("access_token")}getMessages(){return this.messagesSubject.asObservable()}getStreamingAssistant(){return this.streamingAssistantSubject.asObservable()}sendMessage(s){let n=`${this.getUrlSegment()}`,t=JSON.stringify({prompt:s}),r=this.getAccessToken(),h={"Content-Type":"application/json"};return r&&(h.Authorization=`Bearer ${r}`),this.messages.update(f=>[...f,new x(s,"user")]),this.messagesSubject.next(this.messages()),this.status.set(!0),new k(f=>{fetch(n,{method:"POST",headers:h,body:t}).then(S=>{if(!S.body)throw new Error("No response body");let fe=S.body.getReader(),ge=new TextDecoder,_="";this.streamingAssistantSubject.next(""),(async()=>{for(;;){let{done:be,value:ye}=await fe.read();if(be){_&&(this.messages.update(I=>[...I,new x(_,"assistant")]),this.messagesSubject.next(this.messages())),this.status.set(!1),f.complete();break}let ve=ge.decode(ye,{stream:!0}).split(`
`);for(let I of ve)if(I.startsWith("data: "))try{let w=JSON.parse(I.slice(6));w.role==="assistant"&&(_+=w.content||"",this.streamingAssistantSubject.next(_),f.next(w))}catch(w){console.error("Error parsing streamed data:",w)}}})()}).catch(S=>{console.error("Fetch error:",S),this.status.set(!1),f.error(S)})})}resetChat(){this.messages.set([]),this.status.set(!1),this.conversationId.set(""),this.messagesSubject.next(this.messages())}static{this.\u0275fac=function(n){return new(n||e)}}static{this.\u0275prov=H({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})();i();o();O();d();O();var we=(e,p,s,n,t)=>({"bg-chat-user-bg text-chat-user-text ml-auto":e,"bg-chat-assistant-bg text-chat-assistant-text mr-auto":p,"bg-chat-system-bg text-chat-system-text mx-auto text-center":s,"bg-chat-tool-bg text-chat-tool-text mx-auto text-center":n,"bg-chat-developer-bg text-chat-developer-text mx-auto text-center":t}),he=(()=>{class e{static{this.\u0275fac=function(n){return new(n||e)}}static{this.\u0275cmp=y({type:e,selectors:[["app-chat-message"]],inputs:{message:"message"},decls:3,vars:8,consts:[[1,"flex","w-full","mb-3"],[1,"p-3","rounded-lg","max-w-[80%]","whitespace-pre-wrap",3,"ngClass"]],template:function(n,t){n&1&&(a(0,"div",0)(1,"div",1),b(2),m()()),n&2&&(c(),u("ngClass",ne(2,we,t.message.role==="user",t.message.role==="assistant",t.message.role==="system",t.message.role==="tool",t.message.role==="developer")),c(),te(" ",t.message.content," "))},dependencies:[C,re],encapsulation:2})}}return e})();i();o();d();O();d();var xe=["promptInput"],$=(()=>{class e{constructor(){this.isStreaming=!1,this.send=new q,this.reset=new q}focus(){setTimeout(()=>{this.promptInput?.nativeElement.focus()})}onSubmit(){this.send.emit()}onEnter(s){this.isStreaming||this.send.emit(s)}onReset(){this.reset.emit()}static{this.\u0275fac=function(n){return new(n||e)}}static{this.\u0275cmp=y({type:e,selectors:[["app-chat-input"]],viewQuery:function(n,t){if(n&1&&D(xe,5),n&2){let r;R(r=E())&&(t.promptInput=r.first)}},inputs:{form:"form",isStreaming:"isStreaming"},outputs:{send:"send",reset:"reset"},decls:7,vars:3,consts:[["promptInput",""],[1,"flex","gap-2","mt-4",3,"ngSubmit","formGroup"],["type","text","formControlName","prompt","placeholder","Type your message...",1,"flex-1","px-4","py-2","border","border-gray-300","rounded-lg","focus:outline-none","focus:ring-2","focus:ring-blue-500","disabled:bg-gray-100",3,"keydown.enter","disabled"],["type","submit",1,"px-6","py-2","bg-chat-button-primary-bg","text-chat-button-primary-text","rounded-lg","hover:bg-chat-button-primary-hover","focus:outline-none","focus:ring-2","focus:ring-chat-button-primary-focus","disabled:bg-chat-button-primary-disabled","disabled:cursor-not-allowed","transition-colors","duration-200",3,"disabled"],["type","button",1,"px-6","py-2","bg-chat-button-secondary-bg","text-chat-button-secondary-text","rounded-lg","hover:bg-chat-button-secondary-hover","focus:outline-none","focus:ring-2","focus:ring-chat-button-secondary-focus","transition-colors","duration-200",3,"click"]],template:function(n,t){if(n&1){let r=Z();a(0,"form",1),v("ngSubmit",function(){return M(r),j(t.onSubmit())}),a(1,"input",2,0),v("keydown.enter",function(f){return M(r),j(t.onEnter(f))}),m(),a(3,"button",3),b(4," Send "),m(),a(5,"button",4),v("click",function(){return M(r),j(t.onReset())}),b(6," Reset "),m()()}n&2&&(u("formGroup",t.form),c(),u("disabled",t.isStreaming),c(2),u("disabled",t.form.invalid||t.isStreaming))},dependencies:[C,F,ce,ie,oe,ae,ue,me],encapsulation:2})}}return e})();d();var _e=e=>({role:"assistant",content:e});function Ie(e,p){if(e&1&&N(0,"app-chat-message",2),e&2){let s=p.$implicit;u("message",s)}}function ke(e,p){if(e&1&&N(0,"app-chat-message",2),e&2){let s=ee();u("message",se(1,_e,s.streamingAssistantContent()))}}var Rt=(()=>{class e{constructor(){this.destroyRef=l(T),this.fb=l(le),this.chatService=l(de),this.messages=this.chatService.messages,this.streamingAssistantContent=g(""),this.isStreaming=this.chatService.status,this.form=this.fb.group({prompt:[{value:"",disabled:!1},[Q.required,Q.minLength(1)]]}),U(()=>{let s=this.chatService.status(),n=this.form.get("prompt");n&&(s?n.disable():(n.enable(),this.chatInput?.focus()))})}ngOnInit(){this.subscribeToMessages(),this.subscribeToStreaming()}ngAfterViewInit(){this.chatInput?.focus()}subscribeToMessages(){this.chatService.getMessages().pipe(V(this.destroyRef)).subscribe()}subscribeToStreaming(){this.chatService.getStreamingAssistant().pipe(V(this.destroyRef)).subscribe(s=>{this.streamingAssistantContent.set(s)})}async handleSendMessage(s){if(s&&s.preventDefault(),this.form.invalid||this.chatService.status())return;let n=this.form.value.prompt;this.form.reset(),this.streamingAssistantContent.set("");try{this.chatService.sendMessage(n).subscribe({error:t=>{console.error("Failed to send message:",t)}})}catch(t){console.error("Failed to send message:",t)}}resetChat(){this.chatService.resetChat(),this.form.reset(),this.streamingAssistantContent.set(""),this.chatInput?.focus()}static{this.\u0275fac=function(n){return new(n||e)}}static{this.\u0275cmp=y({type:e,selectors:[["app-ai-chat-assistant"]],viewQuery:function(n,t){if(n&1&&D($,5),n&2){let r;R(r=E())&&(t.chatInput=r.first)}},decls:7,vars:3,consts:[[1,"text-xl","font-bold","mb-4","px-4","py-2","text-center"],[1,"h-[calc(100vh-18rem)]","flex","flex-col","flex-1","overflow-y-auto","mb-4","p-4","border","rounded-lg"],[3,"message"],[3,"send","reset","form","isStreaming"]],template:function(n,t){n&1&&(a(0,"h1",0),b(1,"AI Chat Assistant"),m(),a(2,"div",1),X(3,Ie,1,1,"app-chat-message",2,K),z(5,ke,1,3,"app-chat-message",2),m(),a(6,"app-chat-input",3),v("send",function(h){return t.handleSendMessage(h)})("reset",function(){return t.resetChat()}),m()),n&2&&(c(3),Y(t.messages()),c(2),W(t.streamingAssistantContent()&&t.chatService.status()?5:-1),c(),u("form",t.form)("isStreaming",t.chatService.status()))},dependencies:[C,F,he,$],encapsulation:2})}}return e})();export{Rt as AiChatAssistantComponent};
